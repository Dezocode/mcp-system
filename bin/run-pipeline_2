#!/bin/bash
# MCP Claude Pipeline - Enhanced with Web Search & Usage Tracking
# Complete linting â†’ quality patching â†’ development branch publishing
# Claude operates as active worker with real-time guardrail validation
# ğŸ”’ DELETION PROTECTED - Use ./pipeline-security.sh to manage

# DELETION PROTECTION SYSTEM
SCRIPT_PATH="$(realpath "$0")"
SCRIPT_NAME="$(basename "$0")"

# Function to verify deletion attempt and require password
verify_deletion_attempt() {
    if [[ "$0" == *"rm"* ]] || [[ "$1" == "--delete" ]] || [[ "$1" == "--remove" ]]; then
        echo "ğŸš¨ DELETION PROTECTION ACTIVATED"
        echo "================================================================="
        echo "âŒ Attempting to delete protected pipeline file: $SCRIPT_NAME"
        echo "ğŸ”’ This file is critical to the MCP system operation"
        echo ""
        echo "To safely manage this file:"
        echo "  ./pipeline-security.sh status    # Check protection status"
        echo "  ./pipeline-security.sh unprotect # Remove protection (requires password)"
        echo ""
        echo "ğŸ›¡ï¸ Deletion blocked for security"
        echo "================================================================="
        exit 1
    fi
}

# Check for deletion attempts
verify_deletion_attempt "$@"

# Verify file integrity on execution
if [[ -f ".pipeline-security/monitor.sh" ]]; then
    ./.pipeline-security/monitor.sh 2>/dev/null
fi

# USAGE TRACKING SYSTEM
USAGE_DIR=".mcp-usage-tracking"
USAGE_FILE="${USAGE_DIR}/pipeline-usage.log"
CURRENT_TIME=$(date +%s)

# Initialize usage tracking
mkdir -p "${USAGE_DIR}"
touch "${USAGE_FILE}"

# Check usage in last 3 minutes (180 seconds)
check_usage_frequency() {
    local three_minutes_ago=$((CURRENT_TIME - 180))
    local recent_runs=$(awk -v cutoff="$three_minutes_ago" '$1 >= cutoff' "${USAGE_FILE}" | wc -l)
    
    if [[ $recent_runs -ge 3 ]]; then
        echo ""
        echo "âš ï¸  HIGH FREQUENCY USAGE DETECTED"
        echo "================================================================="
        echo "ğŸ• Pipeline has been run ${recent_runs} times in the last 3 minutes"
        echo "ğŸ¤– Consider running in background for continuous processing:"
        echo "   nohup ./run-pipeline --claude-mode > pipeline.log 2>&1 &"
        echo "================================================================="
        echo ""
    fi
    
    # Log this run
    echo "${CURRENT_TIME} $(date)" >> "${USAGE_FILE}"
    
    # Clean old entries (older than 1 hour)
    local one_hour_ago=$((CURRENT_TIME - 3600))
    awk -v cutoff="$one_hour_ago" '$1 >= cutoff' "${USAGE_FILE}" > "${USAGE_FILE}.tmp"
    mv "${USAGE_FILE}.tmp" "${USAGE_FILE}"
}

# WEB SEARCH CAPABILITY SETUP
setup_web_search() {
    echo "ğŸŒ ENHANCED WEB SEARCH CAPABILITY ACTIVATED"
    echo "================================================================="
    echo "ğŸ” Claude now has access to:"
    echo "   â€¢ Real-time web search for latest documentation"
    echo "   â€¢ Code examples and best practices lookup"
    echo "   â€¢ Error resolution and troubleshooting guides"
    echo "   â€¢ Latest MCP protocol updates and changes"
    echo ""
    echo "ğŸ’¡ Web search integration enables:"
    echo "   âœ… Dynamic problem solving with current information"
    echo "   âœ… Access to latest Python/MCP best practices"
    echo "   âœ… Real-time error pattern matching"
    echo "   âœ… Community solutions for complex issues"
    echo "================================================================="
    echo ""
}

# CLAUDE INTEGRATION GUARDRAILS
display_claude_guardrails() {
    echo "ğŸš¨ğŸš¨ğŸš¨ CLAUDE CLI DIRECT GUARDRAIL INSTRUCTIONS ğŸš¨ğŸš¨ğŸš¨"
    echo "================================================================="
    echo "ğŸ“‹ MANDATORY ACTIONS - YOU MUST DO THESE NOW:"
    echo ""
    echo "1ï¸âƒ£ IMMEDIATELY run quality patcher in background:"
    echo "   python3 scripts/claude_quality_patcher.py --claude-agent --max-fixes 10 --fresh-report"
    echo ""
    echo "2ï¸âƒ£ CONTINUOUSLY run linter to verify progress:"
    echo "   python3 scripts/version_keeper.py --comprehensive-lint --lint-only"
    echo ""
    echo "3ï¸âƒ£ MANDATE: Continue applying fixes until linter shows 0 errors"
    echo "   - Apply EVERY fix shown by quality patcher"
    echo "   - Use Read tool first, then Edit/MultiEdit tools"
    echo "   - After each batch, run linter to check progress"
    echo "   - DO NOT STOP until ALL issues are resolved"
    echo ""
    echo "4ï¸âƒ£ WEB SEARCH ENHANCED: Research solutions when stuck"
    echo "   - Search for Python best practices and error solutions"
    echo "   - Look up MCP protocol documentation when needed"
    echo "   - Find community solutions for complex linting issues"
    echo ""
    echo "5ï¸âƒ£ Quality patcher will AUTOMATICALLY grab latest session lint"
    echo "   - Each run uses freshest lint report from session"
    echo "   - Validates your changes in real-time"
    echo "   - Creates backups before each fix attempt"
    echo ""
    echo "âš¡ ENFORCEMENT: System tracks if you apply fixes or not"
    echo "ğŸ›¡ï¸ GUARDRAILS: All changes are validated automatically"
    echo "ğŸ”„ CONTINUOUS: Keep running until 0 errors remain"
    echo "ğŸŒ WEB SEARCH: Use for research and problem solving"
    echo "================================================================="
    echo ""
}

# PIPELINE FILES INVENTORY
display_pipeline_inventory() {
    echo "ğŸ“ AVAILABLE PIPELINE FILES FOR CLAUDE"
    echo "================================================================="
    echo "ğŸ”§ Core Pipeline Components:"
    
    if [[ -f "run-pipeline" ]]; then
        echo "   âœ… run-pipeline - Main execution script ($(wc -c < run-pipeline) bytes)"
    fi
    
    if [[ -f "run-direct-pipeline" ]]; then
        echo "   âœ… run-direct-pipeline - Direct execution script ($(wc -c < run-direct-pipeline) bytes)"
    fi
    
    if [[ -f "mcp-claude-pipeline.py" ]]; then
        echo "   âœ… mcp-claude-pipeline.py - Master orchestrator ($(wc -c < mcp-claude-pipeline.py) bytes)"
    fi
    
    echo ""
    echo "ğŸ Python Components:"
    for file in mcp-*.py auto-discovery-system.py; do
        if [[ -f "$file" ]]; then
            echo "   âœ… $file ($(wc -c < "$file") bytes)"
        fi
    done
    
    echo ""
    echo "ğŸ“œ Script Tools:"
    if [[ -d "scripts" ]]; then
        for script in scripts/*.py; do
            if [[ -f "$script" ]]; then
                echo "   âœ… $(basename "$script") ($(wc -c < "$script") bytes)"
            fi
        done
    fi
    
    echo ""
    echo "âš™ï¸ Configuration & Security:"
    for config in requirements.txt .flake8 pipeline-security.sh; do
        if [[ -f "$config" ]]; then
            echo "   âœ… $config ($(wc -c < "$config") bytes)"
        fi
    done
    
    echo ""
    echo "ğŸ“‚ Directories Available:"
    for dir in configs installers utils docs; do
        if [[ -d "$dir" ]]; then
            local file_count=$(find "$dir" -type f | wc -l)
            echo "   ğŸ“ $dir/ ($file_count files)"
        fi
    done
    
    echo "================================================================="
    echo ""
}

# STRICT GUARDRAILS SYSTEM
enforce_strict_guardrails() {
    echo "ğŸ›¡ï¸ STRICT GUARDRAILS ENFORCEMENT ACTIVE"
    echo "================================================================="
    echo "ğŸš¨ MANDATORY COMPLIANCE REQUIREMENTS:"
    echo ""
    echo "âœ… NO FILE CREATION: Only edit existing files unless critical"
    echo "âœ… READ FIRST: Always use Read tool before Edit/MultiEdit"
    echo "âœ… BACKUP SAFETY: All changes automatically backed up"
    echo "âœ… VALIDATION: Every change validated by quality patcher"
    echo "âœ… PROGRESS TRACKING: Continuous lint monitoring required"
    echo "âœ… WEB RESEARCH: Use search for complex problem solving"
    echo ""
    echo "âŒ PROHIBITED ACTIONS:"
    echo "   â›” Creating unnecessary files or documentation"
    echo "   â›” Ignoring linter errors or quality issues"
    echo "   â›” Making changes without validation"
    echo "   â›” Stopping before all issues are resolved"
    echo ""
    echo "ğŸ¯ SUCCESS CRITERIA: 0 linter errors, validated pipeline"
    echo "================================================================="
    echo ""
}

# BACKGROUND EXECUTION PROMPT
prompt_background_execution() {
    echo "ğŸš€ CLAUDE BACKGROUND EXECUTION RECOMMENDATION"
    echo "================================================================="
    echo "ğŸ’¡ For optimal performance, consider running in background:"
    echo ""
    echo "   # Start pipeline in background with full logging"
    echo "   nohup ./run-pipeline --claude-mode > pipeline-$(date +%Y%m%d_%H%M%S).log 2>&1 &"
    echo ""
    echo "   # Monitor progress"
    echo "   tail -f pipeline-*.log"
    echo ""
    echo "   # Check running processes"
    echo "   ps aux | grep run-pipeline"
    echo ""
    echo "ğŸ”„ Background execution enables:"
    echo "   âœ… Continuous processing without interruption"
    echo "   âœ… Session persistence across terminal sessions"
    echo "   âœ… Complete logging for troubleshooting"
    echo "   âœ… Resource efficient operation"
    echo "================================================================="
    echo ""
}

# Generate session ID with timestamp
SESSION_ID="session_$(date +%Y%m%d_%H%M%S)"
SESSION_DIR="pipeline-outputs/sessions/${SESSION_ID}"

echo "ğŸš€ MCP CLAUDE PIPELINE - ENHANCED CONTINUOUS EXECUTION"
echo "================================================================="
echo ""

# Execute all new features
check_usage_frequency
setup_web_search
display_pipeline_inventory
display_claude_guardrails
enforce_strict_guardrails
prompt_background_execution

echo "ğŸ“¦ Executing complete pipeline with all components coordinated"
echo "ğŸ¤– Claude operates as active worker with real-time guardrail system" 
echo "ğŸ›¡ï¸ Quality patcher provides continuous validation and backup management"
echo "ğŸ”„ Pipeline runs continuously until ALL issues are resolved"
echo "ğŸŒ Web search capability active for enhanced problem solving"
echo "ğŸ“‚ Session ID: ${SESSION_ID}"
echo "ğŸ“ Output Directory: ${SESSION_DIR}"
echo ""

# Create session-specific directory structure
echo "ğŸ“ Creating session directory structure..."
mkdir -p "${SESSION_DIR}"/{lint,quality,pipeline,logs,artifacts}
echo "âœ… Session directories created"

# Ensure we're in the right directory
if [[ ! -f "mcp-claude-pipeline.py" ]]; then
    echo "âŒ Error: mcp-claude-pipeline.py not found in current directory"
    echo "   Please run from the MCP system root directory"
    exit 1
fi

# Check Python 3 availability
if ! command -v python3 &> /dev/null; then
    echo "âŒ Error: python3 not found"
    echo "   Please install Python 3.8+ to run the pipeline"
    exit 1
fi

# Export session info for the pipeline to use
export MCP_SESSION_ID="${SESSION_ID}"
export MCP_SESSION_DIR="${SESSION_DIR}"
export MCP_WEB_SEARCH_ENABLED="true"

# Set continuous execution parameters
CONTINUOUS_PARAMS="--continuous-mode --non-interactive --max-cycles=999 --target-issues=0 --publish-pipeline"

# Check for Claude mode flag to enable minimal output
CLAUDE_MODE=""
for arg in "$@"; do
    if [[ "$arg" == "--claude-mode" ]]; then
        CLAUDE_MODE="--claude-mode"
        echo "ğŸ¤– CLAUDE MODE ENABLED - Minimal output for speed"
        break
    fi
done

# Execute the master orchestrator with continuous parameters
echo "ğŸ”¥ Starting master orchestrator in CONTINUOUS MODE..."
echo "ğŸ¯ Parameters: ${CONTINUOUS_PARAMS}"
echo "ğŸ›¡ï¸ Quality patcher guardrail system will monitor ALL file changes"
echo "âš¡ Pipeline will run until ALL issues are resolved"
echo "ğŸŒ Web search capability enabled for enhanced problem solving"
echo ""
echo "ğŸš¨ CLAUDE INTEGRATION ACTIVE"
echo "ğŸ“‹ When fixes are shown, use Read tool then Edit/MultiEdit tools to apply them"
echo "ğŸ” Use web search for research when encountering complex issues"
echo "ğŸ”„ Pipeline will validate your changes automatically and continue"
echo ""

# Force non-buffered output for real-time monitoring
export PYTHONUNBUFFERED=1

# Execute with continuous parameters - this runs until ALL issues are resolved
python3 mcp-claude-pipeline.py --session-dir="${SESSION_DIR}" ${CONTINUOUS_PARAMS} ${CLAUDE_MODE} "$@"

# Check result
PIPELINE_EXIT_CODE=$?
if [[ $PIPELINE_EXIT_CODE -eq 0 ]]; then
    echo ""
    echo "ğŸ‰ CONTINUOUS PIPELINE EXECUTION SUCCESSFUL!"
    echo "âœ… ALL ISSUES RESOLVED - Zero issues remaining"
    echo "ğŸš€ Development branch published and ready for testing"
    echo "ğŸ“Š Session results saved to: ${SESSION_DIR}"
    echo "ğŸ“‹ Comprehensive final report available in session directory"
    echo "ğŸ¯ Pipeline achieved target: 0 issues remaining"
    echo "ğŸŒ Web search capability utilized for enhanced problem solving"
else
    echo ""
    echo "âŒ CONTINUOUS PIPELINE EXECUTION INCOMPLETE"
    echo "âš ï¸  Pipeline may have encountered issues during continuous processing"
    echo "ğŸ” Session logs saved to: ${SESSION_DIR}/logs/"
    echo "ğŸ“ Check session directory for troubleshooting: ${SESSION_DIR}"
    echo "ğŸ”„ Pipeline will retry automatically - Claude integration may be needed"
    echo "ğŸŒ Consider using web search for researching complex issues"
    echo "ğŸ’¡ Check CLAUDE_PIPELINE_INTEGRATION.md for guidance"
fi

echo ""
echo "ğŸ“‚ Session Directory Structure:"
echo "   ${SESSION_DIR}/"
echo "   â”œâ”€â”€ lint/          # Lint reports and analysis"
echo "   â”œâ”€â”€ quality/       # Quality patches and fixes"
echo "   â”œâ”€â”€ pipeline/      # Pipeline execution reports"
echo "   â”œâ”€â”€ logs/          # Execution logs"
echo "   â””â”€â”€ artifacts/     # Additional artifacts"
echo ""
echo "ğŸ“Š Usage Tracking: Run frequency monitored for optimization"
echo "ğŸŒ Web Search: Enabled for enhanced problem-solving capabilities"
echo ""

exit $PIPELINE_EXIT_CODE